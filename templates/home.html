{% extends 'base.html' %}

{% block title %}Dashboard - Grocery Store Management{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Products</h6>
                        <h4 class="mb-0" id="totalProducts">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-boxes fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Customers</h6>
                        <h4 class="mb-0" id="totalCustomers">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Today's Orders</h6>
                        <h4 class="mb-0" id="todaysOrders">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-shopping-cart fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Revenue Today</h6>
                        <h4 class="mb-0" id="todaysRevenue">₹0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-rupee-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
        <div class="row">
            <div class="col-md-3 mb-2">
                <a href="/orders/create" class="btn btn-primary btn-lg w-100">
                    <i class="fas fa-plus-circle"></i> New Order
                </a>
            </div>
            <div class="col-md-3 mb-2">
                <a href="/products/add" class="btn btn-success btn-lg w-100">
                    <i class="fas fa-box"></i> Add Product
                </a>
            </div>
            <div class="col-md-3 mb-2">
                <a href="/customers/add" class="btn btn-info btn-lg w-100">
                    <i class="fas fa-user-plus"></i> Add Customer
                </a>
            </div>
            <div class="col-md-3 mb-2">
                <a href="/orders" class="btn btn-warning btn-lg w-100">
                    <i class="fas fa-list"></i> View Orders
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity & Popular Products -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-star"></i> Popular Products</h5>
            </div>
            <div class="card-body">
                <div id="popularProducts" class="row row-cols-1 row-cols-md-2 g-3">
                    <div class="col-12 text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> Recent Orders</h5>
            </div>
            <div class="card-body">
                <div id="recentOrders">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    loadPopularProducts();
    loadRecentOrders();
});

// Load dashboard statistics
function loadDashboardData() {
    // Load total products
    fetch('/api/products')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalProducts').textContent = data.length || 0;
        })
        .catch(error => console.error('Error loading products:', error));
    
    // Load total customers
    fetch('/api/customers')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalCustomers').textContent = data.length || 0;
        })
        .catch(error => console.error('Error loading customers:', error));
    
    // Load today's orders and revenue
    fetch('/api/orders/today')
        .then(response => response.json())
        .then(data => {
            document.getElementById('todaysOrders').textContent = data.count || 0;
            document.getElementById('todaysRevenue').textContent = formatCurrency(data.revenue || 0);
        })
        .catch(error => {
            console.error('Error loading today\'s data:', error);
            document.getElementById('todaysOrders').textContent = '0';
            document.getElementById('todaysRevenue').textContent = '₹0';
        });
}

// Load popular products
function loadPopularProducts() {
    fetch('/api/products/popular')
        .then(response => response.json())
        .then(products => {
            renderPopularProducts(products);
        })
        .catch(error => {
            console.error('Error loading popular products:', error);
            document.getElementById('popularProducts').innerHTML = 
                '<div class="col-12"><div class="alert alert-warning">Unable to load popular products</div></div>';
        });
}

// Load recent orders
function loadRecentOrders() {
    fetch('/api/orders/recent')
        .then(response => response.json())
        .then(orders => {
            renderRecentOrders(orders);
        })
        .catch(error => {
            console.error('Error loading recent orders:', error);
            document.getElementById('recentOrders').innerHTML = 
                '<div class="alert alert-warning">Unable to load recent orders</div>';
        });
}

// Render popular products
function renderPopularProducts(products) {
    if (!products || products.length === 0) {
        document.getElementById('popularProducts').innerHTML = 
            '<div class="col-12"><div class="alert alert-info">No products available</div></div>';
        return;
    }
    
    let html = '';
    products.slice(0, 6).forEach(product => {
        html += `
            <div class="col">
                <div class="card h-100 product-card">
                    <div class="card-body p-3">
                        <h6 class="card-title text-truncate">${product.name}</h6>
                        <p class="card-text mb-1">
                            <span class="text-success fw-bold">${formatCurrency(product.price_per_unit)}</span>
                            <small class="text-muted">per ${product.uom_name}</small>
                        </p>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">ID: ${product.product_id}</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('popularProducts').innerHTML = html;
}

// Render recent orders
function renderRecentOrders(orders) {
    if (!orders || orders.length === 0) {
        document.getElementById('recentOrders').innerHTML = 
            '<div class="alert alert-info">No recent orders</div>';
        return;
    }
    
    let html = '';
    orders.slice(0, 5).forEach(order => {
        const orderDate = new Date(order.datetime);
        html += `
            <div class="border-bottom pb-2 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">Order #${order.order_id}</h6>
                        <small class="text-muted">${order.customer_name}</small>
                    </div>
                    <div class="text-end">
                        <div class="text-success fw-bold">${formatCurrency(order.total)}</div>
                        <small class="text-muted">${orderDate.toLocaleDateString()}</small>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('recentOrders').innerHTML = html;
}

// Format currency function
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    }).format(amount || 0);
}
</script>
{% endblock %}