{% extends 'base.html' %}

{% block title %}Inventory Management - Grocery Store{% endblock %}

{% block content %}
<!-- Inventory Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="bg-warning text-dark rounded p-4">
            <h1 class="mb-2"><i class="fas fa-warehouse"></i> Inventory Management</h1>
            <p class="mb-0">Monitor stock levels, track inventory value, and manage product availability</p>
        </div>
    </div>
</div>

<!-- Inventory Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Total Products</h6>
                        <h4 class="mb-0" id="totalProducts">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-boxes fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Low Stock Items</h6>
                        <h4 class="mb-0" id="lowStockCount">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Out of Stock</h6>
                        <h4 class="mb-0" id="outOfStock">0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-times-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">Inventory Value</h6>
                        <h4 class="mb-0" id="inventoryValue">â‚¹0</h4>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-rupee-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Low Stock Alerts -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Low Stock Alerts</h5>
            </div>
            <div class="card-body">
                <div id="lowStockAlerts">
                    <div class="text-center">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stock Management Tools -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-cogs"></i> Stock Management</h5>
                    <div class="btn-group" role="group">
                        <button class="btn btn-primary" onclick="refreshInventory()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-success" onclick="showBulkUpdateModal()">
                            <i class="fas fa-edit"></i> Bulk Update
                        </button>
                        <button class="btn btn-info" onclick="exportInventory()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Search and Filter -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" id="searchProducts" placeholder="Search products..." onkeyup="filterProducts()">
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="stockFilter" onchange="filterProducts()">
                            <option value="all">All Products</option>
                            <option value="low">Low Stock Only</option>
                            <option value="out">Out of Stock Only</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="categoryFilter" onchange="filterProducts()">
                            <option value="all">All Categories</option>
                            <option value="grains">Grains & Cereals</option>
                            <option value="dairy">Dairy Products</option>
                            <option value="vegetables">Vegetables</option>
                            <option value="fruits">Fruits</option>
                        </select>
                    </div>
                </div>

                <!-- Products Table -->
                <div class="table-responsive">
                    <table class="table table-hover" id="inventoryTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Product ID</th>
                                <th>Product Name</th>
                                <th>Current Stock</th>
                                <th>UOM</th>
                                <th>Price per Unit</th>
                                <th>Stock Value</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Stock Modal -->
<div class="modal fade" id="updateStockModal" tabindex="-1" aria-labelledby="updateStockModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateStockModalLabel">Update Stock</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateStockForm">
                    <input type="hidden" id="productId">
                    <div class="mb-3">
                        <label for="productName" class="form-label">Product</label>
                        <input type="text" class="form-control" id="productName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="currentStock" class="form-label">Current Stock</label>
                        <input type="text" class="form-control" id="currentStock" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="newStock" class="form-label">New Stock Quantity</label>
                        <input type="number" class="form-control" id="newStock" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="stockReason" class="form-label">Reason for Change</label>
                        <select class="form-control" id="stockReason">
                            <option value="restock">Restock/Purchase</option>
                            <option value="damaged">Damaged/Expired</option>
                            <option value="theft">Theft/Loss</option>
                            <option value="correction">Stock Correction</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateStock()">Update Stock</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allProducts = [];
let inventorySummary = {};

document.addEventListener('DOMContentLoaded', function() {
    loadInventoryData();
});

// Load inventory data
function loadInventoryData() {
    loadInventorySummary();
    loadLowStockAlerts();
    loadAllProducts();
}

// Load inventory summary
function loadInventorySummary() {
    fetch('/api/inventory/summary')
        .then(response => response.json())
        .then(data => {
            inventorySummary = data;
            document.getElementById('totalProducts').textContent = data.total_products || 0;
            document.getElementById('lowStockCount').textContent = data.low_stock_count || 0;
            document.getElementById('outOfStock').textContent = data.out_of_stock || 0;
            document.getElementById('inventoryValue').textContent = formatCurrency(data.total_inventory_value || 0);
        })
        .catch(error => {
            console.error('Error loading inventory summary:', error);
        });
}

// Load low stock alerts
function loadLowStockAlerts() {
    fetch('/api/inventory/low-stock')
        .then(response => response.json())
        .then(products => {
            renderLowStockAlerts(products);
        })
        .catch(error => {
            console.error('Error loading low stock alerts:', error);
            document.getElementById('lowStockAlerts').innerHTML = 
                '<div class="alert alert-danger">Failed to load low stock alerts</div>';
        });
}

// Load all products for inventory table
function loadAllProducts() {
    fetch('/api/products')
        .then(response => response.json())
        .then(products => {
            allProducts = products;
            renderInventoryTable(products);
        })
        .catch(error => {
            console.error('Error loading products:', error);
            document.getElementById('inventoryTableBody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Failed to load products</td></tr>';
        });
}

// Render low stock alerts
function renderLowStockAlerts(products) {
    if (!products || products.length === 0) {
        document.getElementById('lowStockAlerts').innerHTML = 
            '<div class="alert alert-success">ðŸŽ‰ No low stock items! All products have adequate inventory.</div>';
        return;
    }
    
    let html = '<div class="row">';
    products.forEach(product => {
        const stockClass = product.stock_quantity === 0 ? 'danger' : 'warning';
        const stockIcon = product.stock_quantity === 0 ? 'times-circle' : 'exclamation-triangle';
        
        html += `
            <div class="col-md-4 mb-3">
                <div class="alert alert-${stockClass}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1"><i class="fas fa-${stockIcon}"></i> ${product.name}</h6>
                            <small>Stock: ${product.stock_quantity} ${product.uom_name}</small><br>
                            <small>Price: ${formatCurrency(product.price_per_unit)}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-${stockClass}" onclick="showUpdateModal(${product.product_id}, '${product.name}', ${product.stock_quantity})">
                            <i class="fas fa-plus"></i> Restock
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    document.getElementById('lowStockAlerts').innerHTML = html;
}

// Render inventory table
function renderInventoryTable(products) {
    if (!products || products.length === 0) {
        document.getElementById('inventoryTableBody').innerHTML = 
            '<tr><td colspan="8" class="text-center">No products found</td></tr>';
        return;
    }
    
    let html = '';
    products.forEach(product => {
        const stock = product.stock_quantity || 100; // Default stock if not set
        const stockValue = stock * product.price_per_unit;
        const stockStatus = getStockStatus(stock);
        const statusClass = getStatusClass(stock);
        
        html += `
            <tr>
                <td>${product.product_id}</td>
                <td><strong>${product.name}</strong></td>
                <td><span class="badge bg-${statusClass}">${stock}</span></td>
                <td>${product.uom_name}</td>
                <td>${formatCurrency(product.price_per_unit)}</td>
                <td>${formatCurrency(stockValue)}</td>
                <td><span class="badge bg-${statusClass}">${stockStatus}</span></td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="showUpdateModal(${product.product_id}, '${product.name}', ${stock})" title="Update Stock">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    document.getElementById('inventoryTableBody').innerHTML = html;
}

// Get stock status text
function getStockStatus(stock) {
    if (stock === 0) return 'Out of Stock';
    if (stock < 10) return 'Low Stock';
    if (stock < 50) return 'Medium Stock';
    return 'Good Stock';
}

// Get status badge class
function getStatusClass(stock) {
    if (stock === 0) return 'danger';
    if (stock < 10) return 'warning';
    if (stock < 50) return 'info';
    return 'success';
}

// Show update stock modal
function showUpdateModal(productId, productName, currentStock) {
    document.getElementById('productId').value = productId;
    document.getElementById('productName').value = productName;
    document.getElementById('currentStock').value = currentStock;
    document.getElementById('newStock').value = currentStock;
    
    const modal = new bootstrap.Modal(document.getElementById('updateStockModal'));
    modal.show();
}

// Update stock
function updateStock() {
    const productId = document.getElementById('productId').value;
    const newStock = document.getElementById('newStock').value;
    
    if (!newStock || newStock < 0) {
        alert('Please enter a valid stock quantity');
        return;
    }
    
    fetch('/api/inventory/update-stock', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_id: productId,
            stock_quantity: parseInt(newStock)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('updateStockModal'));
            modal.hide();
            
            // Refresh data
            loadInventoryData();
            
            // Show success message
            showNotification('Stock updated successfully!', 'success');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error updating stock:', error);
        alert('Failed to update stock');
    });
}

// Filter products
function filterProducts() {
    const searchTerm = document.getElementById('searchProducts').value.toLowerCase();
    const stockFilter = document.getElementById('stockFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    
    let filteredProducts = allProducts.filter(product => {
        const matchesSearch = product.name.toLowerCase().includes(searchTerm);
        
        let matchesStock = true;
        const stock = product.stock_quantity || 100;
        if (stockFilter === 'low') matchesStock = stock < 10;
        if (stockFilter === 'out') matchesStock = stock === 0;
        
        // Simple category matching - you can enhance this
        let matchesCategory = true;
        if (categoryFilter !== 'all') {
            // This is a simple implementation - you might want to add category field to products
            matchesCategory = true; // For now, show all
        }
        
        return matchesSearch && matchesStock && matchesCategory;
    });
    
    renderInventoryTable(filteredProducts);
}

// Refresh inventory
function refreshInventory() {
    showNotification('Refreshing inventory...', 'info');
    loadInventoryData();
}

// Export inventory (basic implementation)
function exportInventory() {
    const data = allProducts.map(product => ({
        'Product ID': product.product_id,
        'Product Name': product.name,
        'Stock': product.stock_quantity || 100,
        'UOM': product.uom_name,
        'Price': product.price_per_unit,
        'Stock Value': (product.stock_quantity || 100) * product.price_per_unit
    }));
    
    const csv = convertToCSV(data);
    downloadCSV(csv, 'inventory-report.csv');
    showNotification('Inventory exported successfully!', 'success');
}

// Helper functions
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
    }).format(amount || 0);
}

function showNotification(message, type) {
    // Simple notification - you can enhance this
    const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
    const notification = `<div class="alert ${alertClass} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
    
    document.body.insertAdjacentHTML('afterbegin', notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) alert.remove();
    }, 3000);
}

function convertToCSV(objArray) {
    const array = [Object.keys(objArray[0])].concat(objArray);
    return array.map(it => Object.values(it).toString()).join('\n');
}

function downloadCSV(csv, filename) {
    const csvFile = new Blob([csv], { type: 'text/csv' });
    const downloadLink = document.createElement('a');
    downloadLink.download = filename;
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = 'none';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
}
</script>
{% endblock %}
